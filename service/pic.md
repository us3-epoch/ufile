# 图片处理服务

图片处理服务是 UCloud 对外提供的海量、安全、低成本高可靠的图片处理服务。用户将原始图片上传保存在对象存储空间中，用户可以在任何时间、任何地点、任何设备上对图片进行处理。

图片处理服务仅在下载时触发，目前北京、上海、台北支持所有功能，只有北京和上海地域支持像素10000*10000的图片处理请求。

图片处理服务提供以下功能：

1. 基本图片信息获取

2. EXIF 信息获取

3. 图片缩放

4. 图片裁剪

5. 索引切割

6. 内切圆

7. 圆角矩形

8. 图片旋转

9. 图片自适应方向

10. 图片亮度

11. 图片对比度

12. 图片锐化

13. 图片模糊

14. 获取图片主色调

15. 水印

16. 图片格式转换

17. 图片渐进显示

18. 管道顺序调用多种图片处理功能

## 基本图片信息获取

图片基本信息包括图片格式、图片大小。

在图片下载 URL 后附加 imageinfo 指示符（区分大小写），即可获取 JSON 格式的图片基本信息。

| 参数名    | 值         | 解释  |
| ------ | --------- | --- |
| iopcmd | imageinfo | 主命令 |

## EXIF信息获取

EXIF（EXchangeable Image File Format）是专门为数码相机的照片设定的可交换图像文件格式，通过在图片下载 URL 后附加 exif 指示符（区分大小写）获取。

注意：缩略图等经过处理的新图片不支持该方法。

| 参数名    | 值    | 解释  |
| ------ | ---- | --- |
| iopcmd | exif | 主命令 |

## 图片缩放

| 参数名   | 值           | 解释                                                                      |
| ------- | ------------ | ----------------------------------------------------------------------- |
| iopcmd  | thumbnail    | 主命令                                                                     |
| type    | 1            | 按比例缩放                                                                   |
| type    | 2            | 宽度不变，高度按百分比缩放                                                           |
| type    | 3            | 高度不变，宽度按百分比缩放                                                           |
| type    | 4            | 指定宽度 ，高度等比缩放                                                            |
| type    | 5            | 指定高度，宽度等比缩放                                                             |
| type    | 6            | widthXheight，限定长边，短边自适应缩放                                               |
| type    | 7            | widthXheight，限定短边，长边自适应缩放                                               |
| type    | 8            | widthXheight，指定高和宽的最小尺寸，等比缩放，如只指定高或宽，则未指定边按照指定数值进行裁剪.但是超出指定矩形会被居中裁剪     |
| type    | 9            | 以大的缩放比例进行等比缩放，缩放后可以小于指定的矩形，如高的缩放比例更大，以高为准等比缩放                           |
| type    | 10           | 以小的缩放比例进行等比缩放，缩放后可以大于指定的矩形， 如宽的缩放比例更小，以宽为准等比缩放                          |
| type    | 11           | 使用指定的宽和高，会导致图像拉伸                                                        |
| type    | 12           | 原图尺寸小于 widthXheight 目标尺寸，原图居中，四周补 color 颜色                                  |
| type    | 13           | 等比缩放，一边先缩到目标值，另一边居中裁剪，传 widthXheight                                     |
| type    | 14           | 等比缩放，目标会小于等于 widthXheight                                                |
| type    | 15           | 等比缩放，目标会等于 widthXheight，不足的边，补 color 颜色                                    |
| color   | 十六进制或颜色名 red 等 |                                                                         |
| scale   | 最大 10000      | 缩放百分比                                                                   |
| gifmode |              | 该参数只对 gif 图片有效。若不传，则该参数默认为 1                                               |
| gifmode | 1            | 返回连续的图像帧，如果不能处理全部的图像帧则只返回部分，同 3                                          |
| gifmode | 2            | 返回第一帧静态图片，图像格式仍为 gif                                                     |
| gifmode | 3            | 在系统处理的超时时间内，返回连续的图像帧，如果不能处理全部的图像帧则只返回部分                                 |
| gifmode | 4            | 在系统处理的超时时间内，如果不能处理全部的图像帧，则返回部分跳跃的图像帧，图像帧平均分布                            |
| gifmode | 5            | 在系统处理的超时时间内，如果不能处理全部的图像帧，则返回部分跳跃的图像帧，图像帧平均分布，同时用前一帧填充跳跃的帧，保持处理前后总帧数数量不变 |
| gifmode | 6            | 在系统处理的超时时间内，如果不能处理全部的图像帧，则返回部分跳跃的图像帧，图像帧平均分布，同时修改图像帧的延迟时间，使播放速度和原图相同    |

## 图片裁剪

| 参数名     | 值                                                                    | 解释                         |
| ------- | -------------------------------------------------------------------- | -------------------------- |
| iopcmd  | crop                                                                 | 主命令                        |
| width   | 0-10000                                                              | 裁剪后宽度                      |
| height  | 0-10000                                                              | 裁剪后高度                      |
| ax      | 0-10000                                                              | 锚点 x 坐标                    |
| ay      | 0-10000                                                              | 锚点 y 坐标                    |
| gravity | NorthWest/North/NorthEast/West Center/East/SouthWest/South/SouthEast | 位置偏移指示符，可以和锚点同时指定(比锚点优先使用) |

## 索引切割
| 参数名     | 值                                                                    | 解释                         |
| ------- | -------------------------------------------------------------------- | -------------------------- |
| iopcmd  | indexcrop                                                                 | 主命令                        |
| x       | 1-图片宽度                                                            | x方向切割的每块区域长度                      |
| y       | 1-图片高度                                                            | y方向切割的每块区域长度                      |
| i       | 0-区域数，默认0表示第一块                                                |       选择切割后返回图片的区域              |
### 注意事项
- 如果指定索引值大于切割后形成的区域数量，将返回原图
- 当x和y同时指定值合法时，按照y的参数为准

## 内切圆
| 参数名     | 值                                                                    | 解释                         |
| ------- | -------------------------------------------------------------------- | -------------------------- |
| iopcmd  | circle                                                                 | 主命令                        |
| r       | 1-4096                                                            | 指定内切圆半径                      |
### 注意事项
- 如果图片的源格式是PNG、WebP或BMP等支持透明通道的图片，那么图片的非圆型区域将以透明补充，如果图片的源格式是JPG，图片的非圆形区域会以白色进行填充
- 当r的取值大于原图最小边的一半时，以原图最小边的一半为值返回内切圆

## 圆角矩形
| 参数名     | 值                                                                    | 解释                         |
| ------- | -------------------------------------------------------------------- | -------------------------- |
| iopcmd  | rounded-corners                                                                 | 主命令                        |
| r       | 1-4096                                                            | 将图片切出圆角，指定圆角的半径                      |
### 注意事项
- 如果图片的源标格式是PNG、WebP或BMP等支持透明通道的图片，那么图片的圆角以外区域将以透明补充，如果图片的源格式是JPG，图片的圆角以外区域会以白色进行填充

## 图片旋转

| 参数名    | 值         | 解释        |
| ------ | --------- | --------- |
| iopcmd | rotate    | 主命令       |
| degree | \[0,360\] | 旋转度数(顺时针) |

## 自适应方向
| 参数名     | 值                                                                    | 解释                         |
| ------- | -------------------------------------------------------------------- | -------------------------- |
| iopcmd  | auto-orient                                                                 | 主命令                        |
| value   | 0，1                                                 | 0:不对图片进行自适应方向旋转，1:对图片进行自适应方向旋转  |

## 亮度
| 参数名     | 值                                                                    | 解释                         |
| ------- | -------------------------------------------------------------------- | -------------------------- |
| iopcmd  | bright                                                                 | 主命令                        |
| value   | [-100,100]                                                | <0:降低图片亮度，=0:不调整图片亮度，>0:提高图片亮度 |
### 注意事项
- 如果取值>=100或者<=-100，图片会变成全白或者全黑

## 对比度
| 参数名     | 值                                                                    | 解释                         |
| ------- | -------------------------------------------------------------------- | -------------------------- |
| iopcmd  | contrast                                                                 | 主命令                        |
| value   | [-100,100]                                                | <0:降低图片对比度，=0:不调整图片对比度，>0:提高图片对比度 |
### 注意事项
- 如果取值>=100或者<=-100，图片会变成全白或者全黑

## 锐化
| 参数名     | 值                                                                    | 解释                         |
| ------- | -------------------------------------------------------------------- | -------------------------- |
| iopcmd  | sharpen                                                                | 主命令                        |
| radius   | [50,300]                                                | 设置锐化半径         |
| sigma   | [50,300]                                                 | 设置正态分布标准差      |
### 注意事项
- 锐化半径radius越大，越清晰，但是数值过大，计算会比较慢，可能会出现失真情况，sigma建议设置锐化半径的三分之一

## 模糊
| 参数名     | 值                                                                    | 解释                         |
| ------- | -------------------------------------------------------------------- | -------------------------- |
| iopcmd  | blur                                                                | 主命令                        |
| type  | 0，1                                                                | 0:普通模糊，1:高斯模糊，不传默认为普通模糊   |
| radius   | [0,50]                                         | 设置锐化半径，默认为0     |
| sigma   | [0,50]                                           | 设置正态分布标准差，不传默认为0   |
| width   | 0-10000                                                              | 局部模糊的宽度，不传默认为图片的宽度，为全部模糊       |
| height  | 0-10000                                                              | 局部模糊的宽度，不传默认为图片的宽度，为全部模糊       |
| ax      | 0-10000                                                              | 锚点 x 坐标                    |
| ay      | 0-10000                                                              | 锚点 y 坐标                    |
| gravity | NorthWest/North/NorthEast/West Center/East/SouthWest/South/SouthEast | 位置偏移指示符，可以和锚点同时指定(比锚点优先使用) |

## 获取图片主色调
| 参数名     | 值                                                                    | 解释                         |
| ------- | -------------------------------------------------------------------- | -------------------------- |
| iopcmd  | averagehue                                                           | 返回图片的主色调                      |

## 水印

| 参数名         | 值                                                                    | 解释                                                                         |
| ----------- | -------------------------------------------------------------------- | -------------------------------------------------------------------------- |
| iopcmd      | watermark                                                            | 主命令                                                                        |
| type        | 1=文字水印，2=图片水印                                                        | 水印类型                                                                 |
| gravity     | NorthWest/North/NorthEast/West Center/East/SouthWest/South/SouthEast | 位置偏移指示符，可以和锚点同时指定(比锚点优先使用)                                    |
| opacity     | 1-100，缺省为 100（完全不透明）                                                  | 透明度                                                                |
| ax          | 小于原图宽度，默认为 10                                                         | 锚点 x 坐标                                                            |
| ay          | 小于原图高度，默认为 10                                                         | 锚点 y 坐标                                                            |
| text        |                                                                      | base64 URL encode 后的水印文字，支持 UTF-8。                                     |
| imageurl    |                                                                      | 可访问的图片资源URI，水印图片，必须是可以访问的资源地址，经过 base64 URL encode。       |
| font        |                                                                      | base64 URL encode 后的字体名称                                                  |
| fontsize    | 1-100                                                                | 水印文字大小，缺省为10，字体大小。                                                 |
| rotate    | 0-360                                                                  | 水印文字旋转角度，默认为0，不旋转 。                                               |
| direction   | 1=RightToLeft，2=LeftToRight                                          | 水印文字方向                                                                  |
| fill        |                                                                      | RGB 颜色编码表，base64 URL encode 后的RGB格式，可以是颜色名称（比如red）或十六进制（比如\#FF0000），缺省为白色。 |
| font     |                字体格式编码类型对应表如下                                                      | 默认宋体                 |

font参数中可选的文字类型以及编码
|字体    | 中文名                                                                    | 编码值                       |
| ------- | -------------------------------------------------------------------- | -------------------------- |
| SimSun | 宋体   |             5a6L5L2T    /      U2ltU3Vu                       | 
| LiShu | 隶书   |            TGlTaHU                                                    | 
| FangZhengFangSong |   方正仿宋     |          RmFuZ1poZW5nRmFuZ1Nvbmc=                                                         | 
| FangZhengHeiTi |   方正黑体  |                RmFuZ1poZW5nSGVpVGk=                                                     | 
| FangZhengKaiTi |   方正楷体 | RmFuZ1poZW5nS2FpVGk=                                        | 
| FangZhengShuSong |   方正书宋     |          RmFuZ1poZW5nU2h1U29uZw==                                                           | 
| WenQuanWeiMiHei |    微泉微米黑 |              V2VuUXVhbldlaU1pSGVp                                                    | 
| WenQuanYiZhengHei |      微泉驿正黑  |           V2VuUXVhblpoZW5nSGVp                                                | 
| DroidSansFallback | DroidSansFallback    |            RHJvaWRTYW5zRmFsbGJhY2s=                                                 | 


## 图片格式转换

| 参数名    | 值                | 解释                                                             |
| ------ | ---------------- | -------------------------------------------------------------- |
| iopcmd | convert          | 主命令                                                            |
| dst    | jpg/png/bmp/webp | 目标格式                                                           |
| Q      | 0-100            | 图片压缩质量（绝对压缩比），目标格式为 jpg，webp 时有效                                 |
| q      | 0-100            | 图片压缩质量（相对压缩比），即在图片原有压缩基础上按此比例进行压缩，目标格式为 jpg，webp 时有效，Q 与 q 同时出现时，取 Q |
| fr     | 0.0-1.0          | 需要格式转换的图像帧在图像总帧中的位置，默认为 0.0                                     |

## 渐进显示
| 参数名     | 值                                                                    | 解释                         |
| ------- | -------------------------------------------------------------------- | -------------------------- |
| iopcmd  | interlace                                                                 | 主命令                        |
| value   | 0，1                                                 | 0:不对图片进行渐进显示，1:对图片进行渐进显示  |
### 注意事项
- 目前渐进显示只适用于处理为JPG格式图片，原图不是JPG格式可以通过管道形式，将图片转换成JPG格式

## 管道顺序调用多种图片处理功能

管道顺序是一种可以实现多种图片处理任务顺序执行的机制。用户可以通过管道顺序在一次下载时中按照顺序完成对图像的不同处理。

如：

```
http://ufile-release.cn-bj.ufileos.com/US3pic/demo.jpg?iopcmd=rotate&degree=180|iopcmd=thumbnail&type=1&scale=40
```

上述请求会将 demobucket 这个空间中的 here-for-example.jpg 文件先旋转 180 度，然后按比例缩放为原来的 40% 大小。

注意：如果请求当前不支持的 iopcmd，则会报错，不会返回原图。

## 图片样式

US3 支持用户以固定的 iopcmd 样式形式进行图片处理的调用，实现方式如下：

1. 用户编辑固定的图片处理调用方式，如：

```
http://ufile-release.cn-bj.ufileos.com/US3pic/demo.jpg?iopcmd=rotate&degree=180|iopcmd=thumbnail&type=1&scale=40|iopcmd=watermark&type=1&gravity=SouthEast&text=VUNsb3Vk&fontsize=100
```

实际进行的图片处理操作为进行一次图片翻转操作，按比例缩放为40%大小，在右下角增加字体大小为100的文字水印“UCloud”。

2. 用户将以上调用方式设置为'style1'样式。

3. 在访问图片处理时，采用样式调用方式，以设置的样式方式进行图片处理操作：

```
http://ufile-release.cn-bj.ufileos.com/US3pic/demo.jpg?iopcmd=style1
```

**注：该功能处于内测阶段，如需使用请联系技术支持。**
